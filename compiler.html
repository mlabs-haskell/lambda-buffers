<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Compiler - Lambda Buffers documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="haskell.html"><strong aria-hidden="true">3.</strong> LambdaBuffers to Haskell</a></li><li class="chapter-item expanded "><a href="purescript.html"><strong aria-hidden="true">4.</strong> LambdaBuffers to Purescript</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">5.</strong> Design</a></li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">6.</strong> API</a></li><li class="chapter-item expanded "><a href="syntax.html"><strong aria-hidden="true">7.</strong> LambdaBuffers Frontend (.lbf) syntax</a></li><li class="chapter-item expanded "><a href="compiler.html" class="active"><strong aria-hidden="true">8.</strong> Compiler</a></li><li class="chapter-item expanded "><a href="codegen.html"><strong aria-hidden="true">9.</strong> Codegen</a></li><li class="chapter-item expanded "><a href="command-line-interface.html"><strong aria-hidden="true">10.</strong> Command line interface</a></li><li class="chapter-item expanded "><a href="comparison-matrix.html"><strong aria-hidden="true">11.</strong> Comparison matrix</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lambda Buffers documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lambdabuffers-compiler"><a class="header" href="#lambdabuffers-compiler">LambdaBuffers Compiler</a></h1>
<p>The <em>Compiler</em> component sits between the <em>Frontend</em> component and the code
generation component named <em>Codegen</em>. The purpose of the <em>Compiler</em> is to
perform various checks on the <a href="../lambda-buffers-proto/compiler-proto.html#lambdabuffers-compiler-CompilerInput">Compiler
input</a>
provided by the <em>Frontend</em> ensuring that supplied type, class and instance
clause definitions are valid or otherwise communicate any error conditions
determined during processing.</p>
<p>The end goal of the <em>Compiler</em> is to ensure that the <em>Codegen</em> component is
capable of processing the <em>Compiler Output</em> by providing correct and complete
information.</p>
<h2 id="compiler-interface"><a class="header" href="#compiler-interface">Compiler Interface</a></h2>
<p>The <em>Compiler</em> operates on the <em>Compiler Input</em> message specified in the
<a href="../lambda-buffers-proto/compiler.proto">compiler.proto</a> <a href="https://protobuf.dev/">Google Protocol
Buffers</a> schema - enabling, any <em>Frontend</em> to interface
with the <em>Compiler</em> in a language agnostic manner.</p>
<p>Similarly, the <em>Compiler Output</em> message is also specified in the
<a href="../lambda-buffers-proto/compiler.proto">compiler.proto</a> <a href="https://protobuf.dev/">Google Protocol
Buffers</a> schema that is then consumed by <em>Codegen</em>
modules, able to be written in any programming environment capable of
communicating via <a href="https://protobuf.dev/">Google Protocol Buffers</a>.</p>
<p>Refer to the <a href="../lambda-buffers-proto/compiler-proto.html">Compiler Proto
documentation</a> for more information.</p>
<h2 id="checking-type-definitions"><a class="header" href="#checking-type-definitions">Checking Type Definitions</a></h2>
<p>The first step the Compiler performs is <em>kind checking and inference</em> on <a href="../lambda-buffers-proto/compiler-proto.html#lambdabuffers-compiler-TyDef">type
definitions</a>
provided by the <em>Frontend</em> and otherwise raises <a href="#missing-link">kind checking errors</a>.</p>
<p>When successful, the Compiler outputs a <a href="#missing-link">Compiler Output</a> that
annotates each <a href="../lambda-buffers-proto/compiler-proto.html#lambdabuffers-compiler-Ty">type
term</a> with
<a href="../lambda-buffers-proto/compiler-proto.html#lambdabuffers-compiler-Kind">kind</a>
information.</p>
<p>In standard <em>type checking</em> terminology LambdaBuffers 'terms' are <a href="https://en.wikipedia.org/wiki/Abstract_data_type">abstract data
type</a> declarations and their
'types' are <em>kinds</em>.</p>
<p>Currently, the <em>Compiler</em> accepts:</p>
<ol>
<li>
<p>type terms of kind <code>Type</code> (such as <code>Int</code> or <code>Bool</code>),</p>
</li>
<li>
<p>type function terms of kind <code>Type → Type</code> (such as <code>Maybe</code> or <code>Either</code> -
though note that type functions are not &quot;first class&quot; in the sense that they
cannot be passed as arguments to other type functions).</p>
</li>
</ol>
<p>There are future plans to expand this to Higher Kinded Types (such as <code>MaybeT</code>,
<code>StateT</code> etc - i.e. types parameterized on type function terms) - subject to
research into <em>Codegen</em> of such types in the target languages.</p>
<p>The <em>Compiler</em> supports recursive types.</p>
<p>All LambdaBuffers <a href="../lambda-buffers-proto/compiler-proto.html#lambdabuffers-compiler-TyArg">type
variables</a>
terms must be monomorphically kinded, with polymorphic kinds defaulting to
monomorphic ones. For example <code>Phantom a = Phantom</code> would resolve to the
monomorphic kind <code>Type → Type</code> rather than the polymorphic kind <code>∀a. a → Type</code>.</p>
<h3 id="kind-checker"><a class="header" href="#kind-checker">Kind Checker</a></h3>
<p>The kind checker is designed around a simply typed lambda calculus type system
with inference via unification (<em>John Alan Robinson's</em> unification algorithm is
being currently used). We've also introduced a <code>let</code> binding rule that allows
later additions to the typing context. The typing rules are the following:</p>
<pre><code class="language-text"> x : σ ∈ Γ
----------- [Variable]
 Γ ⊢ x : σ


      Γ,x:σ ⊢ e:τ
------------------------ [Abstraction]
 Γ ⊢ (λ x:σ. e):(σ → τ)


Γ ⊢ x:(σ → τ)    Γ ⊢ y:σ
------------------------- [Application]
       Γ ⊢ x y : τ


Γ ⊢ e₁:σ    Γ, e₁ : σ ⊢ e₂:τ
----------------------------- [Let]
   Γ ⊢ let x = e₁ in e₂ : τ
</code></pre>
<p>The type checking strategy is as follows:</p>
<ol>
<li>
<p>A context is built from the type definitions. Type variables which are not
annotated with any further kind information are defaulted to be of kind
<code>Type</code>.</p>
</li>
<li>
<p>The RHS of the type terms are converted into their <em>Sums of Products</em>
canonical representation. The variables from the left hand side of the term
are introduced to the right hand side as abstractions.</p>
</li>
<li>
<p>The derivation for each term is built.</p>
</li>
<li>
<p>Then the unification tries to find a solution.</p>
</li>
</ol>
<p>Terms for which unification cannot find a consistent derivation are deemed
incorrect and a kind checking error is thrown. Note that currently all of the
inferred kinds have a restriction to be monomorphic - therefore no free or
universally quantified variables can appear in the final kind signature.</p>
<h2 id="checking-type-cardinality"><a class="header" href="#checking-type-cardinality">Checking Type Cardinality</a></h2>
<p>In addition to <em>kind checking</em>, the Compiler could perform a special check for
types to determine their cardinality. This is especially useful to catch and
report on <em>non inhabited</em> types that users might define.</p>
<p>For example, <code>data F a = F (F a)</code> declares a <em>non-inhabited recursive type</em> that
can't be constructed. LambdaBuffers Compiler <em>SHOULD</em> reject such types as they
can't possibly be constructed and generated typeclass instances would in turn be
ill-defined.</p>
<p>This problem is equivalent to a problem of <a href="https://en.wikipedia.org/wiki/Component_(graph_theory)">calculating graph
components</a>.</p>
<h2 id="normalizing-type-definitions"><a class="header" href="#normalizing-type-definitions">Normalizing Type Definitions</a></h2>
<p>Finally, the compiler should be able to <em>normalize</em> expressions. For example, it
may be possible to define a data type in the schema language in a form similar
to: <code>data G a = G ((Either) ((Maybe) a) Int)</code>, where the bracketing indicates
the order of application within the term. The example term would normalize to
<code>data G a = G (Either (Maybe a) Int)</code> - resulting in a cleaner (and more
performant) code generation.</p>
<h2 id="checking-typeclass-definitions-and-instance-clauses"><a class="header" href="#checking-typeclass-definitions-and-instance-clauses">Checking Typeclass Definitions and Instance Clauses</a></h2>
<p>The <em>Compiler</em> should, if possible, ensure that all instance declarations for
schemata are derivable using hard-coded derivation axioms.</p>
<p>Other schema languages support generating type definitions in many languages
from a single definition in the schema language. One key feature that sets
LambdaBuffers apart from these alternatives is support for
<a href="https://en.wikipedia.org/wiki/Type_class"><em>typeclasses</em></a>, which enable the
generation of <a href="https://en.wikipedia.org/wiki/Ad_hoc_polymorphism">ad-hoc polymorphic
functions</a> that operate on
types generated from LambdaBuffers schemata.</p>
<p>The LambdaBuffers schema language doesn't allow users to specify typeclass instance
implementations themselves. Users, instead, will write <em>instance clauses</em> as
part of the schema definition, and the LambdaBuffers code generator will derive
these declared instances when generating code.</p>
<p>Two important consequences of this design decision are:</p>
<ol>
<li>
<p><em>All instances must be derived structurally</em>. As an example, consider the
arbitrary product type <code>data P a b = P a b</code>. The semantics of the generated
instance (i.e. the behavior of the generated code) must be determinable from the
<em>structure of the type</em> - that it is a product - and the instances for its
arguments <code>a</code> and <code>b</code>, and by those features alone. (Since <code>a</code> and <code>b</code> are type
variables here, writing a direct instance for any interesting class is likely
impossible, so LambdaBuffers supports constrained instances such as <code>instance (C a, C b) =&gt; C (P a b)</code>)</p>
</li>
<li>
<p><em>All instances must be uniform across supported languages</em>. Because the
LambdaBuffers <em>Codegen</em> component (and <em>not</em> the user) is responsible for
generating instances, we must ensure that the codegen component is suitably
equipped to generate instances in each language that exhibit behavior which is,
to the greatest extent possible, equivalent to the behavior of generated
instances in any other language. We <em>must</em> have an extensive test quite to
verify uniform behavior of generated instances.</p>
</li>
</ol>
<p>In languages with a typeclass system (Haskell, PureScript) or equivalent (Rust's
Traits), we will utilize the existing system and <em>should</em> (to the extent that
doing so is feasible) utilize existing typeclasses and instances from commonly
used or standard libraries. In languages lacking a type system that is
sufficiently rich to express typeclass relations, we will generate instances
using idiomatic language features. (The details will depend on the particular
language.)</p>
<h2 id="missing-link"><a class="header" href="#missing-link">Missing link</a></h2>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="syntax.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="codegen.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="syntax.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="codegen.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
